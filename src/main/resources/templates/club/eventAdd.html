<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<th:block th:replace="~{/layouts/base :: base(~{this::content})}">
    <th:block th:fragment="content">
        <!--  TODO 텍스트 에디터 API  -->

        <div id="boardAddWrapper" class="mt-5">

            <form class="container mt-4" th:object="${eventBoardForm}" method="post" action="" th:action >

                <!-- 제목, 게시글 분류 선택 -->
                <div class="row mb-4 ">

                    <div class="col-12 input-group input-group-lg">

                        <span class="input-group-text">제목</span>
                        <input type="text" class="form-control" th:field="*{title}">

                    </div>

                </div>

                <!-- 작품 선택 -->
                <div class="row mb-4">

                    <div class="col-12 input-group input-group-lg">

                        <label for="search-text" class="input-group-text">작품 선택</label>
                        <div class="input-group-text">
                            <input class="form-check-input mt-0" id="programSelectCheck" type="checkbox" th:field="*{programId}" value="">
                        </div>

                        <input type="text" id="search-text" class="form-control dropdown-toggle search-input"
                               data-bs-toggle="dropdown" aria-expanded="false">
                        <ul class="dropdown-menu overflow-scroll" id="searched-list">
                            <!-- 동적으로 드롭다운 검색 결과 -->
                        </ul>

                    </div>

                </div>

                <!--  모임 일정 / 모집 마감 일자  -->
                <div class="row mb-4 ">

                    <div class="col-12 input-group input-group-lg">

                        <!--  모임 날짜  -->
                        <div class="form-group">
                            <span class="input-group-text">날짜</span>
                            <input type="date" class="form-control" th:field="*{eventDate}" id="eventDate">
                        </div>
                        <!--  달력형 모집 마감 일자  -->
                        <div class="form-group">
                            <span class="input-group-text" >모집 마감 일자</span>
                            <input type="date" class="form-control" th:field="*{deadlineDate}" id="deadlineDate">
                        </div>

                    </div>

                </div>

                <!--  인원  -->
                <div class="row mb-4 ">

                    <div class="col-12 input-group input-group-lg">

                        <div class="form-group">
                            <span class="input-group-text">최대 인원</span>
                            <input type="number" class="form-control" th:field="*{maxPeople}" min="2" id="maxPeople">
                        </div>

                    </div>

                </div>

                <!--  모임 자동 수락 여부  -->
                <div class="row mb-4 ">

                    <div class="col-12 input-group input-group-lg">

                        <label class="input-group-text">모임 참가 신청을 자동으로 수락합니다.</label>
                        <div class="input-group-text">
                            <input class="form-check-input mt-0" type="checkbox" th:field="${autoAccept}" checked>
                        </div>

                    </div>

                </div>

                <!--  필터링 영역  -->
                <div class="row mb-4 ">

                    <div class="col-12 input-group input-group-lg">

                        <span class="input-group-text">성별</span>
                        <select class="form-control" th:field="*{filterGender}" id="filterGender">
                            <option th:each="filterGender: ${filterGender}"
                                    th:value="${filterGender.name()}"
                                    th:text="${filterGender.value}">  <!--  TODO selected 수정  -->
                            </option>
                        </select>

                        <span class="input-group-text" for="filterMinAge">최소 연령</span>
                        <input type="number" class="form-control" th:field="*{filterMinAge}" min="0" id="filterMinAge">

                        <span class="input-group-text">최대 연령</span>
                        <input type="number" class="form-control" th:field="*{filterMaxAge}" min="0" id="filterMaxAge">


                    </div>

                </div>

<!--                <div class="form-group">-->
<!--                    <label class="text-blank" for="thumbnail">썸네일 이미지</label>-->
<!--                    <input type="file" th:field="*{thumbnail}" class="form-control" id="thumbnail">-->
<!--                </div>  &lt;!&ndash;  todo 이미지 첨부 기능 예정  &ndash;&gt;-->
<!--                <div class="form-group">-->
<!--                    <label class="text-blank" for="image">본문 이미지 첨부</label>-->
<!--                    <input type="file" th:field="*{image}" class="form-control" id="image">-->
<!--                </div>  &lt;!&ndash;  todo 이미지 첨부 기능 예정  &ndash;&gt;-->

                <!--  내용 영역  -->
                <div class="row mb-4">
                    <div class="input-group input-group-lg">

                        <label for="content-textarea" class="input-group-text">내용</label>

                    </div>
                </div>
                <div class="row mb-4">
                    <div class="input-group">

                        <textarea th:field="*{content}" rows="30" class="form-control" id="content-textarea">

                        </textarea>
                    </div>
                </div>

                <div class="row">
                    <div class="input-group">
                        <button type="button" class="btn btn-info" th:onclick="|location.href='@{/clubs/list}'|">취소
                        </button>
                        <button type="submit" class="btn btn-primary">등록</button>
                    </div>
                </div>

            </form>

        </div>

        <script th:inline="javascript">
            $(document).ready(function () {
                var programId = null;

                // 작품 분류 선택시 값 변경
                $('.dropdown-menu').on('click', '.boardTypeValue', function () {
                    // 버튼 기본 기능 비활성화
                    event.preventDefault();
                // #dropdown-menu 값 변경
                $('#boardTypeValue').val($(this).data('type'));
                // 버튼 텍스트 변경
                $('.bTypeBtn').text($(this).text());
                // #boardType 값 변경
                $('#boardType').val($(this).data('type'));
                });

                // 검색창에 값변경시
                $('#search-text').on('keyup', function () {
                    console.log($(this).val());
                    $.ajax({
                        url: '/program/search/' + $(this).val(),
                        type: 'GET',
                        success: function (data) {
                            console.log(data);
                            changeDropdown(data);
                            programId = null;
                            // 드롭다운 보여주기
                            $('#searched-list').css('display', 'block')
                            console.log(programId);
                        }
                    });
                });

                // 드롭다운 내부 값 변경
                function changeDropdown(data) {
                    let html = '';
                    data.forEach(function (program) {
                        html += '<li><a class="dropdown-item search-value" href="#" data-programId="' + program.id + '">' + program.title + '</a></li>';
                    });
                    $('#searched-list').html(html);
                }

                // 드롭다운 내부 클릭시 input에 값 넣기
                $(document).on('click', '.search-value', function () {
                    console.log($(this).text());
                    $('#search-text').val($(this).text());
                    programId = $(this).data('programid');
                    $('#searched-list').css('display', 'none');
                });


                // #search-list 외부 클릭과 #search-text 포커스 아웃시 드롭다운 숨기기
                $(document).on('click', function (e) {
                    if (!$(e.target).closest('#searched-list').length && !$(e.target).closest('#search-text').length) {
                        $('#searched-list').css('display', 'none');
                    }
                });
                // #search-text 포커스시 드롭다운 보여주기
                $('#search-text').on('focus', function () {
                    $('#searched-list').css('display', 'block');
                });

                // 체크박스 클릭시
                $('#programSelectCheck').on('click', function () {
                    if (programId == null) {
                        alert('작품을 선택해주세요');
                        $('#programSelectCheck').prop('checked', false);
                    } else if ($('#programSelectCheck').val() == programId) {
                        // 체크박스 값 변경
                        $('#programSelectCheck').val('');
                        // readonly 속성 제거
                        $('#search-text').prop('readonly', false);
                        $('#programSelectCheck').prop('checked', false);
                        console.log($('#programSelectCheck').val());
                    } else {
                        // 체크박스 값 변경
                        $('#programSelectCheck').val(programId);
                        // readonly 속성 추가
                        $('#search-text').prop('readonly', true);
                        console.log($('#programSelectCheck').val());
                    }
                });

                // 현재 날짜 계산
                var now_utc = Date.now();
                var timeOff = new Date().getTimezoneOffset() * 60000;
                var today = new Date(now_utc - timeOff);

                // minEventDate = today + 2
                var minEventDate = new Date(today);
                minEventDate.setDate(today.getDate() + 2);
                var minEventDateISOString = minEventDate.toISOString().split("T")[0];
                document.getElementById("eventDate").setAttribute("min", minEventDateISOString);

                // eventDate 입력 후
                document.getElementById("eventDate").addEventListener("change", function() {
                    var eventDateValue = this.value;
                    var eventDate = new Date(eventDateValue);

                    // minDeadlineDate = today
                    var minDeadlineDate = new Date();
                    var minDeadlineDateISOString = minDeadlineDate.toISOString().split("T")[0];
                    document.getElementById("deadlineDate").setAttribute("min", minDeadlineDateISOString);

                    // maxDeadlineDate = eventDate - 2
                    var maxDeadlineDate = new Date(eventDate);
                    maxDeadlineDate.setDate(eventDate.getDate() - 2);
                    var maxDeadlineDateISOString = maxDeadlineDate.toISOString().split("T")[0];
                    document.getElementById("deadlineDate").setAttribute("max", maxDeadlineDateISOString);
                });

            });
        </script>

    </th:block>
</th:block>
</html>